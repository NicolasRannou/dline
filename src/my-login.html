<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymer/lib/elements/dom-if.html">

<link rel="import" href="../bower_components/neon-animation/web-animations.html">

<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">

<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">

<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tab.html">

<link rel="import" href="../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="../bower_components/polymerfire/firebase-query.html">

<link rel="import" href="shared-styles.html">

<dom-module id="my-login">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
      }

      app-header-layout {
        background-color: var(--default-primary-color);
      }

      .content {
        display: flex;
        height: 100%;
        align-items: center;
        justify-content: center;
      }

      .message{
        color: grey;
        text-decoration: none;
        font-size: 12px;
        font-style: italic;
        font-weight: lighter;
      }

      .clickable:hover{
        color: grey;
        text-decoration: underline;
      }

      .card {
        width: 256px;
        min-height: 0;
        margin: auto;
      }

      iron-pages > div {
        display: flex;
        flex-direction: column;
      }

      iron-pages > div > * {
        margin-left: auto;
        margin-right: auto;
        min-width: 200px;
      }

      .title {
        padding: 30px 10px 0px;
        text-align: center;
        font-size: 20px;
      }

      paper-button {
        margin-top: 20px;
      }

      app-header {
        background-color: var(--dark-primary-color);
        color: var(--text-primary-color);
      }
    </style>

    <firebase-auth
      id="FBAuth"
      user="{{user}}"
      signed-in="{{signedIn}}"
      on-error="_handleEmailPWError">
    </firebase-auth>

    <firebase-query
      id="FBSave"
      path="/users/[[user.uid]]/preferences">
    </firebase-query>

    <app-header-layout fullbleed has-scrolling-region>
      <app-header slot="header" fixed condenses effects="waterfall">
        <app-toolbar>
          <div main-title>DLINE - Contouring Atlases</div>
        </app-toolbar>
      </app-header>
      <div class="content">

    <!--<div class="container">-->
      <div class="card">

        <paper-tabs selected="{{selected}}">
          <paper-tab>Sign up</paper-tab>
          <paper-tab>Sign in</paper-tab>
        </paper-tabs>

        <iron-pages selected="{{selected}}">
          <div>
            <div class="title">Create an account</div>
            <paper-input
              id="signupEmail"
              type="email"
              label="Email"
              value="{{email}}"
              validator="email-validator"
              error-message="Invalid email address" required auto-validate></paper-input>
            <paper-input
              id="signupPassword"
              type="password"
              value="{{password}}"
              minlength="6"
              char-counter
              label="Password"
              error-message="Must be at lest 6 characters" required></paper-input>
            <paper-input
              id="signupPasswordConfirm"
              type="password"
              value="{{passwordMatch}}"
              type="password"
              label="Confirm Password"
              error-message="Do not match password"
              required></paper-input>
            <paper-dropdown-menu
              id="signupTitle"
              label="Title"
              selected-item-label="{{title}}" required>
              <paper-listbox slot="dropdown-content" selected="{{titleIndex}}">
                <paper-item>Intern</paper-item>
                <paper-item>Medical Doctor</paper-item>
                <paper-item>Physicist</paper-item>
                <paper-item>Technician</paper-item>
                <paper-item>Other</paper-item>
              </paper-listbox>
            </paper-dropdown-menu>
            <paper-button type="submit" on-tap="_signUp">Sign Up</paper-button>
            <p hidden$="[[!forgotPassword]]" class="message">Email already registered.</p>
          </div>
          <div>
            <div class="title">Log into your account</div>
            <paper-input
              id="signinEmail"
              type="email"
              label="Email"
              value="{{email}}"
              validator="email-validator"
              error-message="Invalid email address" required auto-validate></paper-input>
            <paper-input
              id="signinPassword"
              type="password"
              value="{{password}}"
              label="Password"
              on-keydown="_passwordKeyDown"
              error-message="Invalid password" required></paper-input>
            <paper-button on-tap="_signIn">Sign In</paper-button>
            <p hidden$="[[!forgotPassword]]"><a href="#" class="clickable message" on-click="_resetPassword">Incorrect password. Email new password?</a></p>
            <p hidden$="[[!forgotEmail]]"><a href="#" class="clickable message" on-click="_gotoSignUp">Unkown email. Create account?</a></p>
            [[this.message]]
          </div>
        </iron-pages>
      </div>
    <!--</div>-->

          </div>
    </app-header-layout>

  </template>

  <script>
    class MyLogin extends Polymer.Element {
      static get is() { return 'my-login'; }

      static get properties() {
        return {
          user: {
            type: Object,
            value: {},
            observer: '_userChanged',
          },
          selected: {
            type: Number,
            value: 1,
          },
          email: {
            type: String,
          },
          password: {
            type: String,
            observer: '_passwordChanged',
          },
          passwordMatch: {
            type: String,
            observer: '_passwordMismatch',
          },
          message: {
            type: String,
            value: '',
          },
          forgotPassword: {
            type: Boolean,
            value: false,
          },
          forgotEmail: {
            type: Boolean,
            value: false,
          },
          signedIn: {
            type: Boolean,
            observer: '_signedInChanged',
          },
          newTitle: {
            type: String,
          },
        };
      }

      _signIn(e) {
        // validate
        const validEmail = this.$.signinEmail.validate();
        const validPassword = this.$.signinPassword.validate();

        if (validEmail && validPassword) {
          this.$.FBAuth.signInWithEmailAndPassword(this.email, this.password);
        }
      }

      _signUp(e) {
        // validate
        const validEmail = this.$.signupEmail.validate();
        const validPassword = this.$.signupPassword.validate();
        const validPasswordConfirm = !this._passwordMismatch(this.passwordMatch);
        const validTitle = this.$.signupTitle.validate();

        if (validEmail &&
          validPassword &&
          validPasswordConfirm &&
          validTitle) {

          // sign up and sign in!
          this.newTitle = this.title;
          this.$.FBAuth.createUserWithEmailAndPassword(this.email, this.password);
        }
      }

      _handleEmailPWError(err) {
        if(err.detail.code === "auth/wrong-password"){
          // sign in with wrong password
          this.$.signinPassword.invalid = true;
          this.forgotPassword = true;
          this.forgotEmail = false;
        } else if(err.detail.code === "auth/user-not-found") {
          // sign in with wrong email
          this.$.signinEmail.invalid = true;
          this.forgotPassword = false;
          this.forgotEmail = true;
        } else if(err.detail.code === "auth/email-already-in-use") {
          // sign up with wrong email
          this.newTitle = undefined;
          this.$.signupPassword.invalid = true;
          this.forgotPassword = true;
          this.forgotEmail = false;
        } else {
          this.email = null;
          this.selected = 1;
          this.forgotPassword = false;
          this.forgotEmail = false;
        }

        this.password = undefined;
        this.passwordMatch = undefined;
      }
  
      _resetPassword() {
        const validEmail = this.$.signinEmail.validate();
        if (validEmail) {
          this.$.FBAuth.auth.sendPasswordResetEmail(this.email);
        }
      }

      _gotoSignUp() {
        this.selected = 0;
      }

      _passwordChanged(password) {
        this.$.signinPassword.validate();
        this.$.signupPassword.validate();
      }

      _passwordMismatch(passwordMatch) {
        let invalid = true;
        if(passwordMatch !== undefined &&
          passwordMatch === this.password) {
          invalid = false;
        }

        this.$.signupPasswordConfirm.invalid = invalid;
        return invalid;
      }

      _signedInChanged(signedIn) {
        this.password = undefined;
        this.passwordMatch = undefined;
        this.title = undefined;
        this.titleIndex = undefined;
        this.selected = 1;
        this.forgotPassword = false;
        this.forgotEmail= false;
      }

      _userChanged(user) {
        if (this.newTitle !== undefined) {
          this.$.FBSave.ref.push({
            title: this.title,
          });
          this.newTitle = undefined;
        }
      }

      _passwordKeyDown(e) {
        if (e.keyCode === 13) {
          this._signIn();
        }
      }
    }

    window.customElements.define(MyLogin.is, MyLogin);
  </script>
</dom-module>
